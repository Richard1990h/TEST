@inherits LayoutComponentBase
@inject UserSessionService Session
@inject NavigationManager Navigation
@inject HttpClient Http
@inject IJSRuntime JS
@implements IDisposable

<style>
    /* Modern AI/Tech MainLayout - Futuristic Design 2025 */
    
    /* Note: CSS Variables are inherited from design-system.css */
    
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    .app-layout {
        display: flex;
        height: 100vh;
        background: var(--bg-canvas);
        overflow: hidden;
        font-family: var(--font-sans);
        transition: background-color 0.3s ease;
    }

    /* ========================================
       SIDEBAR - Glass Effect
       ======================================== */
    .sidebar {
        width: 280px;
        background: var(--bg-glass);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-right: 1px solid var(--border-default);
        display: flex;
        flex-direction: column;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 100;
        overflow-y: auto;
        position: relative;
    }

    [data-theme="dark"] .sidebar {
        background: rgba(10, 15, 26, 0.9);
        border-right-color: var(--border-glow);
        box-shadow: 1px 0 30px rgba(59, 130, 246, 0.05);
    }

    .sidebar-header {
        padding: 1.5rem;
        background: transparent;
        border-bottom: 1px solid var(--border-default);
        flex-shrink: 0;
        position: relative;
    }

    .sidebar-header::after {
        content: '';
        position: absolute;
        bottom: -1px;
        left: 1rem;
        right: 1rem;
        height: 1px;
        background: linear-gradient(90deg, transparent, var(--primary-500), transparent);
        opacity: 0.3;
    }

    [data-theme="dark"] .sidebar-header::after {
        opacity: 0.5;
    }

    .sidebar-header h1 {
        font-size: 1.25rem;
        font-weight: 700;
        margin: 0;
        letter-spacing: -0.03em;
        background: linear-gradient(135deg, var(--primary-500) 0%, var(--accent-purple) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .sidebar-content {
        flex: 1;
        overflow-y: auto;
        padding: 1.25rem;
        scrollbar-width: thin;
        scrollbar-color: var(--border-default) transparent;
    }

    .sidebar-content::-webkit-scrollbar {
        width: 6px;
    }

    .sidebar-content::-webkit-scrollbar-track {
        background: transparent;
    }

    .sidebar-content::-webkit-scrollbar-thumb {
        background: var(--border-default);
        border-radius: 3px;
    }

    .nav-group {
        margin-bottom: 2rem;
    }

    .nav-label {
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        color: var(--text-tertiary);
        margin-bottom: 0.75rem;
        padding-left: 0.75rem;
        letter-spacing: 0.08em;
    }

    .nav-item {
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        color: var(--text-secondary);
        text-decoration: none;
        border-radius: 12px;
        margin-bottom: 0.375rem;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        position: relative;
        border: 1px solid transparent;
    }

    .nav-item:hover {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(139, 92, 246, 0.08) 100%);
        color: var(--text-primary);
        transform: translateX(4px);
        border-color: rgba(59, 130, 246, 0.1);
    }

    [data-theme="dark"] .nav-item:hover {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.12) 0%, rgba(139, 92, 246, 0.12) 100%);
        box-shadow: 0 0 20px rgba(59, 130, 246, 0.1);
    }

    .nav-item.active {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.12) 0%, rgba(139, 92, 246, 0.12) 100%);
        color: var(--primary-500);
        font-weight: 600;
        border-color: rgba(59, 130, 246, 0.2);
    }

    .nav-item.active::before {
        content: '';
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 3px;
        height: 60%;
        background: linear-gradient(180deg, var(--primary-500), var(--accent-purple));
        border-radius: 0 3px 3px 0;
    }

    [data-theme="dark"] .nav-item.active {
        box-shadow: 0 0 25px rgba(59, 130, 246, 0.15);
    }

    .nav-icon {
        margin-right: 0.75rem;
        font-size: 1.15rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 26px;
        height: 26px;
    }

    /* ========================================
       TOP BAR - Modern Glass Header
       ======================================== */
    .top-bar {
        height: 64px;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        padding: 0 1.5rem;
        background: var(--bg-glass);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-bottom: 1px solid var(--border-default);
        position: relative;
        z-index: 200;
    }

    [data-theme="dark"] .top-bar {
        background: rgba(10, 15, 26, 0.8);
        border-bottom-color: var(--border-glow);
        box-shadow: 0 1px 30px rgba(59, 130, 246, 0.05);
    }

    .top-bar::after {
        content: '';
        position: absolute;
        bottom: -1px;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.3), transparent);
    }

    /* Profile button (avatar trigger) */
    .profile-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 0.5rem;
        display: flex;
        align-items: center;
        gap: 10px;
        border-radius: 12px;
        transition: all 0.2s ease;
    }

    .profile-btn:hover {
        background: var(--bg-hover);
    }


/* Avatar circle - Modern gradient with glow */
.avatar-circle {
    width: 38px;
    height: 38px;
    border-radius: 12px;
    background: linear-gradient(135deg, var(--primary-500), var(--accent-purple));
    color: white;
    font-weight: 700;
    font-size: 0.95rem;
    display: flex;
    align-items: center;
    justify-content: center;
    user-select: none;
    box-shadow: 0 2px 10px rgba(59, 130, 246, 0.3);
    transition: all 0.2s ease;
}

.profile-btn:hover .avatar-circle {
    transform: scale(1.05);
    box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
}

[data-theme="dark"] .avatar-circle {
    box-shadow: 0 2px 15px rgba(59, 130, 246, 0.4), 0 0 30px rgba(59, 130, 246, 0.1);
}

/* ========================================
   PROFILE POPOVER - Glass Effect
   ======================================== */
.profile-popover {
    position: absolute;
    top: 64px;
    right: 16px;
    width: 280px;
    background: var(--bg-glass);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 16px;
    box-shadow: var(--shadow-xl);
    padding: 0.5rem;
    z-index: 1000;
    border: 1px solid var(--border-default);
    animation: popoverSlide 0.2s ease-out;
}

[data-theme="dark"] .profile-popover {
    background: rgba(15, 22, 41, 0.95);
    border-color: var(--border-glow);
    box-shadow: var(--shadow-2xl), 0 0 40px rgba(59, 130, 246, 0.1);
}

@@keyframes popoverSlide {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

    .profile-email {
        font-size: 0.85rem;
        color: var(--text-tertiary);
        margin-bottom: 4px;
        word-break: break-all;
    }


    .profile-username {
        font-size: 1.125rem;
        font-weight: 700;
        color: var(--text-primary);
        line-height: 1.2;
        white-space: nowrap;
    }



    .profile-wrapper {
        display: flex;
        align-items: center;
        gap: 12px;
    }

/* Header inside popover */
    .profile-header {
        padding: 0.75rem 1rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        gap: 2px;
        border-bottom: 1px solid var(--border-default);
        margin-bottom: 0.5rem;
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
        border-radius: 12px 12px 0 0;
        margin: -0.5rem -0.5rem 0.5rem -0.5rem;
        padding: 1rem;
    }

        .profile-header strong {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .profile-header small {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            text-transform: capitalize;
        }


/* Buttons inside popover */
.profile-popover button {
    width: 100%;
    padding: 0.75rem 1rem;
    border: none;
    background: transparent;
    text-align: left;
    border-radius: 10px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--text-primary);
    transition: all 0.2s ease;
}

/* Hover */
.profile-popover button:hover {
    background: var(--bg-hover);
    transform: translateX(4px);
}

/* Logout danger style */
.profile-popover .danger {
    color: var(--color-error);
}

.profile-popover .danger:hover {
    background: rgba(239, 68, 68, 0.1);
}

/* Divider line */
.profile-popover .divider {
    height: 1px;
    background: var(--border-default);
    margin: 0.5rem 0;
}

    .profile-overlay {
        position: fixed;
        inset: 0;
        z-index: 999;
    }



    .history-section {
        margin-bottom: 1.5rem;
    }

    .history-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .history-count {
        font-size: 0.65rem;
        color: var(--text-tertiary);
        font-weight: 700;
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
        padding: 0.25rem 0.6rem;
        border-radius: 8px;
        border: 1px solid rgba(59, 130, 246, 0.2);
    }

    .history-list {
        list-style: none;
        padding: 0;
        margin: 0;
        max-height: 400px;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: var(--border-default) transparent;
    }

    .history-list::-webkit-scrollbar {
        width: 6px;
    }

    .history-list::-webkit-scrollbar-track {
        background: transparent;
    }

    .history-list::-webkit-scrollbar-thumb {
        background: var(--border-default);
        border-radius: 3px;
    }

    .history-list.expanded {
        max-height: none;
    }

    .history-item {
        padding: 0.7rem 0.875rem;
        font-size: 0.875rem;
        color: var(--text-secondary);
        border-radius: 10px;
        cursor: pointer;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        margin-bottom: 0.375rem;
        position: relative;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        border: 1px solid transparent;
    }

    .history-item:hover {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(139, 92, 246, 0.08) 100%);
        color: var(--text-primary);
        transform: translateX(4px);
        border-color: rgba(59, 130, 246, 0.15);
    }

    [data-theme="dark"] .history-item:hover {
        box-shadow: 0 0 15px rgba(59, 130, 246, 0.1);
    }

    .history-item-icon {
        flex-shrink: 0;
        font-size: 0.95rem;
    }

    .history-item-text {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .expand-btn {
        background: linear-gradient(135deg, var(--primary-500) 0%, var(--accent-purple) 100%);
        color: white;
        border: none;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        padding: 0.6rem 1rem;
        border-radius: 10px;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        width: 100%;
        text-align: center;
        margin-top: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
    }

    .expand-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.35);
    }

    [data-theme="dark"] .expand-btn {
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3), 0 0 30px rgba(59, 130, 246, 0.1);
    }

    .expand-btn-icon {
        display: inline-block;
        transition: transform 0.2s;
        font-size: 0.65rem;
    }

    .expand-btn.expanded .expand-btn-icon {
        transform: rotate(180deg);
    }

    .history-action-btn {
        border: 1px solid var(--border-default);
        background: var(--bg-tertiary);
        color: var(--text-primary);
        border-radius: 8px;
        padding: 0.3rem 0.6rem;
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .history-action-btn:hover:not(:disabled) {
        background: var(--bg-hover);
        border-color: var(--primary-500);
    }

    .history-action-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .main-view {
        flex: 1;
        display: flex;
        flex-direction: column;
        position: relative;
        height: 100vh;
        overflow: hidden;
        background: var(--bg-canvas);
    }

    .mobile-toggle {
        display: none;
        position: fixed;
        top: 1rem;
        left: 1rem;
        z-index: 1000;
        background: var(--bg-glass);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid var(--border-default);
        padding: 0.6rem 0.875rem;
        border-radius: 12px;
        box-shadow: var(--shadow-lg);
        cursor: pointer;
        font-size: 1.25rem;
        transition: all 0.2s ease;
    }

    .mobile-toggle:hover {
        background: var(--bg-hover);
        transform: scale(1.05);
        box-shadow: var(--shadow-glow);
    }

    .model-selector {
        padding: 1rem;
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
        border-radius: 14px;
        margin-bottom: 1.5rem;
        border: 1px solid rgba(59, 130, 246, 0.1);
        transition: all 0.3s ease;
    }

    [data-theme="dark"] .model-selector {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
        border-color: rgba(59, 130, 246, 0.2);
    }

    .model-selector select {
        width: 100%;
        padding: 0.6rem 0.875rem;
        border-radius: 10px;
        border: 1px solid var(--border-default);
        font-size: 0.9rem;
        background: var(--input-bg);
        color: var(--text-primary);
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .model-selector select:hover {
        border-color: var(--primary-500);
    }

    .model-selector select:focus {
        outline: none;
        border-color: var(--primary-500);
        box-shadow: var(--shadow-focus);
    }

    .sidebar-footer {
        padding: 1.25rem;
        border-top: 1px solid var(--border-default);
        flex-shrink: 0;
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.03) 0%, rgba(139, 92, 246, 0.03) 100%);
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    [data-theme="dark"] .sidebar-footer {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
    }

    .theme-toggle {
        background: var(--bg-tertiary);
        color: var(--text-primary);
        border: 1px solid var(--border-default);
        padding: 0.65rem 1rem;
        border-radius: 12px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        font-weight: 600;
        width: 100%;
        position: relative;
        overflow: hidden;
    }

    .theme-toggle::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
        transition: left 0.4s ease;
    }

    .theme-toggle:hover::before {
        left: 100%;
    }

    .theme-toggle:hover {
        background: var(--bg-hover);
        border-color: var(--primary-500);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    }

    [data-theme="dark"] .theme-toggle:hover {
        box-shadow: 0 4px 20px rgba(59, 130, 246, 0.25);
    }

    .theme-toggle:active {
        transform: translateY(0);
    }

    /* ========================================
       DESKTOP (1920px and above)
       ======================================== */
    @@media (min-width: 1920px) {
        .sidebar {
            width: 320px;
        }

        .sidebar-header {
            padding: 2rem;
        }

        .sidebar-header h1 {
            font-size: 1.5rem;
        }

        .sidebar-content {
            padding: 1.5rem;
        }

        .nav-item {
            padding: 0.875rem 1rem;
            font-size: 1rem;
        }

        .nav-icon {
            font-size: 1.25rem;
            margin-right: 1rem;
        }

        .history-item {
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
        }

        .model-selector {
            padding: 1.25rem;
            margin-bottom: 2rem;
        }

        .model-selector select {
            padding: 0.75rem;
            font-size: 0.95rem;
        }

        .nav-label {
            font-size: 0.8rem;
            margin-bottom: 1rem;
            padding-left: 1rem;
        }

        .nav-group {
            margin-bottom: 2.5rem;
        }

        .expand-btn {
            font-size: 0.85rem;
            padding: 0.7rem 1.125rem;
        }

        .theme-toggle {
            font-size: 0.95rem;
            padding: 0.7rem 1.125rem;
        }
    }

    /* ========================================
       LARGE DESKTOP (1440px - 1919px)
       ======================================== */
    @@media (min-width: 1440px) and (max-width: 1919px) {
        .sidebar {
            width: 300px;
        }

        .sidebar-header {
            padding: 1.75rem;
        }

        .sidebar-header h1 {
            font-size: 1.375rem;
        }

        .sidebar-content {
            padding: 1.25rem;
        }

        .nav-item {
            padding: 0.8rem 1rem;
            font-size: 0.95rem;
        }

        .nav-icon {
            font-size: 1.15rem;
            margin-right: 0.875rem;
        }

        .history-item {
            padding: 0.7rem 0.9rem;
            font-size: 0.875rem;
        }

        .model-selector {
            padding: 1.125rem;
            margin-bottom: 1.75rem;
        }

        .nav-group {
            margin-bottom: 2.25rem;
        }
    }

    /* ========================================
       MEDIUM DESKTOP (1024px - 1439px)
       ======================================== */
    @@media (min-width: 1024px) and (max-width: 1439px) {
        .sidebar {
            width: 280px;
        }

        .sidebar-header {
            padding: 1.5rem;
        }

        .sidebar-header h1 {
            font-size: 1.25rem;
        }

        .sidebar-content {
            padding: 1.125rem;
        }

        .nav-item {
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
        }

        .nav-icon {
            font-size: 1.1rem;
            margin-right: 0.75rem;
        }

        .history-item {
            padding: 0.65rem 0.8rem;
            font-size: 0.85rem;
        }

        .model-selector {
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .nav-group {
            margin-bottom: 2rem;
        }
    }

    /* ========================================
       TABLET (768px - 1023px)
       ======================================== */
    @@media (min-width: 768px) and (max-width: 1023px) {
        .sidebar {
            width: 240px;
        }

        .sidebar-header {
            padding: 1.25rem;
        }

        .sidebar-header h1 {
            font-size: 1.1rem;
        }

        .sidebar-content {
            padding: 0.875rem;
        }

        .nav-item {
            padding: 0.625rem;
            font-size: 0.85rem;
        }

        .nav-icon {
            font-size: 1rem;
            margin-right: 0.625rem;
            width: 20px;
            height: 20px;
        }

        .history-item {
            padding: 0.5rem 0.625rem;
            font-size: 0.8rem;
        }

        .model-selector {
            padding: 0.875rem;
            margin-bottom: 1.25rem;
        }

        .model-selector select {
            padding: 0.375rem;
            font-size: 0.8rem;
        }

        .nav-label {
            font-size: 0.7rem;
            margin-bottom: 0.625rem;
            padding-left: 0.625rem;
        }

        .nav-group {
            margin-bottom: 1.5rem;
        }

        .sidebar-footer {
            padding: 0.875rem;
        }

        .expand-btn {
            font-size: 0.7rem;
            padding: 0.375rem 0.625rem;
        }

        .theme-toggle {
            font-size: 0.8rem;
            padding: 0.375rem 0.625rem;
        }
    }

    /* ========================================
       MOBILE (480px - 767px)
       ======================================== */
    @@media (min-width: 480px) and (max-width: 767px) {
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 220px;
            transform: translateX(-100%);
            box-shadow: 4px 0 12px rgba(0, 0, 0, 0.15);
        }

        .sidebar.open {
            transform: translateX(0);
        }

        .mobile-toggle {
            display: block;
        }

        .main-view {
            margin-left: 0;
        }

        .sidebar-header {
            padding: 1rem;
        }

        .sidebar-header h1 {
            font-size: 1rem;
        }

        .sidebar-content {
            padding: 0.75rem;
        }

        .nav-item {
            padding: 0.5rem;
            font-size: 0.8rem;
        }

        .nav-icon {
            font-size: 0.95rem;
            margin-right: 0.5rem;
            width: 18px;
            height: 18px;
        }

        .history-item {
            padding: 0.5rem;
            font-size: 0.75rem;
        }

        .model-selector {
            padding: 0.75rem;
            margin-bottom: 1rem;
        }

        .model-selector select {
            padding: 0.375rem;
            font-size: 0.75rem;
        }

        .nav-label {
            font-size: 0.65rem;
            margin-bottom: 0.5rem;
        }

        .nav-group {
            margin-bottom: 1.25rem;
        }

        .sidebar-footer {
            padding: 0.75rem;
        }

        .expand-btn {
            font-size: 0.65rem;
            padding: 0.375rem 0.5rem;
        }

        .theme-toggle {
            font-size: 0.75rem;
            padding: 0.375rem 0.5rem;
        }
    }

    /* ========================================
       SMALL MOBILE (320px - 479px)
       ======================================== */
    @@media (max-width: 479px) {
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 100%;
            max-width: 280px;
            transform: translateX(-100%);
            box-shadow: 4px 0 16px rgba(0, 0, 0, 0.2);
        }

        .sidebar.open {
            transform: translateX(0);
        }

        .mobile-toggle {
            display: block;
            padding: 0.5rem;
            font-size: 1.1rem;
        }

        .main-view {
            margin-left: 0;
        }

        .sidebar-header {
            padding: 1rem;
        }

        .sidebar-header h1 {
            font-size: 0.95rem;
        }

        .sidebar-content {
            padding: 0.625rem;
        }

        .nav-item {
            padding: 0.5rem;
            font-size: 0.75rem;
        }

        .nav-icon {
            font-size: 0.9rem;
            margin-right: 0.5rem;
            width: 16px;
            height: 16px;
        }

        .history-item {
            padding: 0.5rem;
            font-size: 0.7rem;
        }

        .model-selector {
            padding: 0.625rem;
            margin-bottom: 0.875rem;
        }

        .model-selector select {
            padding: 0.375rem;
            font-size: 0.7rem;
        }

        .nav-label {
            font-size: 0.6rem;
            margin-bottom: 0.5rem;
        }

        .nav-group {
            margin-bottom: 1rem;
        }

        .sidebar-footer {
            padding: 0.625rem;
        }

        .expand-btn {
            font-size: 0.6rem;
            padding: 0.375rem 0.5rem;
        }

        .theme-toggle {
            font-size: 0.7rem;
            padding: 0.375rem 0.5rem;
        }
    }

    .notif-wrapper{position:relative;display:flex;align-items:center;margin-right:10px;}
    .notif-btn{position:relative;border:none;background:transparent;color:var(--text-primary);cursor:pointer;padding:6px 8px;border-radius:10px;}
    .notif-btn:hover{background:rgba(255,255,255,0.06);}
    .notif-icon{font-size:18px;line-height:1;}
    .notif-badge{position:absolute;top:2px;right:2px;background:var(--warning-color);color:#111827;font-size:11px;font-weight:700;border-radius:999px;padding:1px 6px;min-width:18px;text-align:center;}
    .notif-overlay{position:fixed;top:0;left:0;right:0;bottom:0;width:100vw;height:100vh;z-index:1999;background:transparent;cursor:default;}
    .notif-popover{position:absolute;top:40px;right:0;width:360px;max-height:420px;overflow:auto;background:rgba(20,24,32,0.98);border:1px solid rgba(255,255,255,0.08);border-radius:16px;box-shadow:0 12px 30px rgba(0,0,0,0.45);padding:10px;z-index:2000;}
    .notif-header{display:flex;align-items:center;justify-content:space-between;padding:6px 6px 10px 6px;border-bottom:1px solid rgba(255,255,255,0.08);margin-bottom:8px;}
    .notif-title{font-weight:800;}
    .notif-close{border:none;background:transparent;color:var(--text-secondary);font-size:20px;cursor:pointer;padding:0 6px;}
    .notif-row{padding:10px;color:var(--text-secondary);}
    .notif-item{padding:10px;border-radius:12px;cursor:pointer;border:1px solid rgba(255,255,255,0.06);margin-bottom:8px;background:rgba(255,255,255,0.03);}
    .notif-item:hover{background:rgba(255,255,255,0.06);}
    .notif-item-title{font-weight:700;margin-bottom:4px;color:var(--text-primary);}
    .notif-item-msg{color:var(--text-secondary);font-size:13px;line-height:1.4;}
    .notif-item-time{color:var(--text-tertiary);font-size:12px;margin-top:6px;}

    /* ========================================
       WORKSPACE BUTTON & PANEL
       ======================================== */
    .workspace-btn {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border: none;
        border-radius: 10px;
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%);
        color: var(--primary-500, #3b82f6);
        cursor: pointer;
        transition: all 0.2s ease;
        margin-left: 0.5rem;
    }

    .workspace-btn:hover {
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(59, 130, 246, 0.2) 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
    }

    .workspace-btn svg {
        width: 20px;
        height: 20px;
    }

    .workspace-badge {
        position: absolute;
        top: -4px;
        right: -4px;
        background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        color: white;
        font-size: 0.65rem;
        font-weight: 700;
        padding: 2px 6px;
        border-radius: 10px;
        min-width: 18px;
        text-align: center;
        box-shadow: 0 2px 6px rgba(34, 197, 94, 0.4);
    }

    /* ========================================
       CONTENT AREA WRAPPER - Flexbox Layout
       ======================================== */
    .content-area-wrapper {
        flex: 1;
        display: flex;
        min-height: 0;
        overflow: hidden;
    }

    .chat-area-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
        overflow: hidden;
        transition: flex 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
    }

    .chat-area-container.with-workspace {
        flex: 1;
    }

    .chat-area-container.minimized {
        flex: 0 0 60px;
        min-width: 60px;
        opacity: 0.6;
        overflow: hidden;
    }

    .chat-area-container.minimized:hover {
        opacity: 0.8;
    }

    /* ========================================
       WORKSPACE PANEL - Inline (not overlay)
       ======================================== */
    .workspace-panel-inline {
        flex: 1;
        max-width: 50%;
        min-width: 400px;
        display: flex;
        flex-direction: column;
        background: var(--bg-primary, #0f0f1a);
        border-left: 1px solid var(--border-default, #2a2a4a);
        animation: slideInFromRight 0.25s ease-out;
        transition: flex 0.3s cubic-bezier(0.4, 0, 0.2, 1), max-width 0.3s ease;
    }

    .workspace-panel-inline.expanded {
        flex: 1;
        max-width: calc(100% - 60px);
    }

    @@keyframes slideInFromRight {
        from {
            transform: translateX(30%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    .workspace-panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--border-default, #2a2a4a);
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
        flex-shrink: 0;
    }

    .workspace-panel-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .workspace-title-icon {
        width: 24px;
        height: 24px;
        color: var(--primary-500, #3b82f6);
    }

    .workspace-panel-title h3 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--text-primary, #fff);
    }

    .workspace-header-actions {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .workspace-toggle-chat-btn {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid var(--border-default, #2a2a4a);
        border-radius: 8px;
        background: var(--bg-tertiary, #1a1a2e);
        color: var(--text-secondary, #aaa);
        cursor: pointer;
        transition: all 0.15s ease;
    }

    .workspace-toggle-chat-btn:hover {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
        border-color: var(--primary-500, #3b82f6);
        color: var(--primary-500, #3b82f6);
    }

    .workspace-toggle-chat-btn svg {
        width: 16px;
        height: 16px;
    }

    .workspace-close-btn {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        border-radius: 8px;
        background: transparent;
        color: var(--text-tertiary, #888);
        cursor: pointer;
        transition: all 0.15s ease;
    }

    .workspace-close-btn:hover {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }

    .workspace-close-btn svg {
        width: 18px;
        height: 18px;
    }

    .workspace-panel-content {
        flex: 1;
        display: flex;
        overflow: hidden;
        min-height: 0;
    }

    .workspace-files-section {
        width: 220px;
        min-width: 180px;
        border-right: 1px solid var(--border-default, #2a2a4a);
        display: flex;
        flex-direction: column;
        background: rgba(0, 0, 0, 0.2);
        flex-shrink: 0;
    }

    .workspace-section-header {
        padding: 0.75rem 1rem;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-tertiary, #888);
        border-bottom: 1px solid var(--border-default, #2a2a4a);
        background: rgba(0, 0, 0, 0.2);
        flex-shrink: 0;
    }

    .workspace-file-tree {
        flex: 1;
        overflow-y: auto;
        padding: 0.5rem;
    }

    .workspace-file-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.75rem;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.15s ease;
        margin-bottom: 0.25rem;
    }

    .workspace-file-item:hover {
        background: rgba(59, 130, 246, 0.1);
    }

    .workspace-file-item.selected {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(139, 92, 246, 0.15) 100%);
        border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .file-type-icon {
        font-size: 1rem;
        flex-shrink: 0;
    }

    .file-name-text {
        font-size: 0.8rem;
        color: var(--text-primary, #fff);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .workspace-empty-state, .preview-empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2rem 1rem;
        text-align: center;
        height: 100%;
    }

    .workspace-empty-state .empty-icon, .preview-empty-state .empty-icon {
        font-size: 2.5rem;
        margin-bottom: 0.75rem;
        opacity: 0.5;
    }

    .workspace-empty-state .empty-message, .preview-empty-state .empty-message {
        font-size: 0.9rem;
        color: var(--text-secondary, #aaa);
        font-weight: 600;
    }

    .workspace-empty-state .empty-hint {
        font-size: 0.75rem;
        color: var(--text-tertiary, #888);
        margin-top: 0.25rem;
    }

    .workspace-preview-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        min-width: 0;
    }

    .workspace-preview-area {
        flex: 1;
        overflow: auto;
        padding: 1rem;
    }

    .workspace-preview-area pre {
        margin: 0;
        padding: 1rem;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 10px;
        overflow-x: auto;
    }

    .workspace-preview-area code {
        font-family: 'Fira Code', 'Monaco', 'Consolas', monospace;
        font-size: 0.8rem;
        line-height: 1.6;
        color: var(--text-primary, #fff);
    }

    @@media (max-width: 900px) {
        .workspace-panel-inline {
            min-width: 280px;
            max-width: 100%;
        }

        .workspace-panel-inline.expanded {
            max-width: 100%;
        }

        .chat-area-container.with-workspace {
            display: none;
        }

        .chat-area-container.minimized {
            display: none;
        }

        .workspace-files-section {
            width: 160px;
            min-width: 140px;
        }
    }

</style>


<div class="app-layout">
    <button class="mobile-toggle" @onclick="ToggleSidebar" title="Toggle sidebar">‚ò∞</button>

    @if (Session.IsLoggedIn())
    {
        <!-- ================= SIDEBAR ================= -->
        <div class="sidebar @(sidebarOpen ? "open" : "")">
            <div class="sidebar-header">
                <h1>Assistant</h1>
            </div>

            <div class="sidebar-content">
                <div class="model-selector">
                    <div class="nav-label">AI Model</div>
                    @if (llmLoading)
                    {
                        <div style="font-size: 0.8rem; color: var(--text-secondary); padding: 0.5rem;">
                            Loading model...
                        </div>
                    }
                    else
                    {
                        <select @bind="currentModel" @bind:after="OnModelChanged">
                            @foreach (var model in availableModels)
                            {
                                <option value="@model">@model</option>
                            }
                        </select>
                    }
                </div>

                <div class="nav-group">
                    <div class="nav-item @(IsActive("/") ? "active" : "")"
                         @onclick="@(() => NavigateTo("/"))">
                        <span>New Chat</span>
                    </div>

                    @if (Session.GetUser()?.Role == "Admin")
                    {
                        <div class="nav-item @(IsActive("/admin/panel") ? "active" : "")"
                             @onclick="@(() => NavigateTo("/admin/panel"))">
                            <span>Admin Panel</span>
                        </div>
                    }
                </div>

                <div class="history-section">
                    <div class="history-header">
                        <div class="nav-label">Recent Chats</div>
                        <div style="display:flex; gap:0.5rem; align-items:center;">
                            <button class="history-action-btn"
                                    @onclick="ClearSidebarOnly"
                                    title="Clear sidebar list (client-only)"
                                    disabled="@(!allChats.Any())">
                                Clear
                            </button>

                            <button class="history-action-btn"
                                    @onclick="DeleteAllChats"
                                    title="Delete all chats (backend)"
                                    disabled="@(!allChats.Any())">
                                Delete All
                            </button>

                            @if (totalChatCount > 10)
                            {
                                <div class="history-count">@displayedChatCount/@totalChatCount</div>
                            }
                        </div>
                    </div>

                    @if (!string.IsNullOrWhiteSpace(sidebarError))
                    {
                        <div style="padding:0.5rem 0.75rem; color:#b91c1c; font-size:0.8rem;">
                            @sidebarError
                        </div>
                    }

                    <div class="history-list @(historyExpanded ? "expanded" : "")">
                        @if (displayedChats == null || displayedChats.Count == 0)
                        {
                            <div style="padding:0.5rem 0.75rem; color: var(--text-tertiary); font-size:0.8rem;">
                                No chats yet. Start a new chat.
                            </div>
                        }
                        else
                        {
                            @foreach (var chat in displayedChats)
                            {
                                <div class="history-item"
                                     @onclick="() => LoadChat(chat.Id)"
                                     title="@chat.Title">
                                    <span class="history-item-text">@chat.Title</span>
                                    <button class="history-action-btn"
                                            style="padding:0.1rem 0.35rem;"
                                            title="Delete chat"
                                            @onclick="() => DeleteChat(chat.Id)"
                                            @onclick:stopPropagation="true">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            }
                        }
                    </div>

                    @if (totalChatCount > 10)
                    {
                        <button class="expand-btn @(historyExpanded ? "expanded" : "")" @onclick="ToggleHistoryExpand">
                            @(historyExpanded ? "Show Less" : "Show All (" + totalChatCount + ")")
                            <span class="expand-btn-icon">‚ñº</span>
                        </button>
                    }
                </div>
            </div>
        </div>

        <!-- ================= MAIN VIEW (OUTSIDE SIDEBAR) ================= -->
        <div class="main-view">

            <!-- TOP BAR -->
            <div class="top-bar">
                @if (Session.IsLoggedIn())
                {
                    <div class="profile-wrapper">

                        <!-- üîÅ MOVED credits badge (EXISTING UI) -->
                        <div class="chat-header-actions">
                            <PlanStatusBar />
                        </div>

                        <NotificationsBell />

                        <!-- üë§ EXISTING profile button -->
                        <button class="profile-btn"
                                @onclick="ToggleProfileMenu"
                                title="Account">

                            <div class="avatar-circle">
                                @GetUserLabel().Substring(0, 1).ToUpperInvariant()
                            </div>

                            <span class="profile-username">
                                @GetUserLabel()
                            </span>
                        </button>

                        <!-- üìÅ Workspace button -->
                        <button class="workspace-btn @(IsWorkspaceOpen ? "active" : "")" @onclick="ToggleWorkspace" title="@(IsWorkspaceOpen ? "Close Workspace" : "Open Workspace")">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 7V17C3 18.1046 3.89543 19 5 19H19C20.1046 19 21 18.1046 21 17V9C21 7.89543 20.1046 7 19 7H13L11 5H5C3.89543 5 3 5.89543 3 7Z"/>
                            </svg>
                        </button>

                        </div>
                }
            </div>




            <!-- PROFILE POPOVER -->
            @if (showProfileMenu)
            {
                <!-- click-away overlay -->
                <div class="profile-overlay" @onclick="CloseProfileMenu">

                    <!-- actual popover -->
                    <div class="profile-popover" @onclick:stopPropagation>
                        <div class="profile-header">
                            <strong>@GetUserLabel()</strong>
                            <small>@GetUserRole()</small>
                            <div class="profile-email">
                                @Session.GetUser()?.Email
                            </div>  

                            <!-- üí≥ Plan / Credits summary (shown only in profile popover) -->
                            <div style="margin-top:8px; padding-top:8px; border-top:1px solid var(--border-color);">
                                @if (_profilePlanLoading)
                                {
                                    <div style="font-size:0.85rem; color: var(--text-secondary);">Loading plan‚Ä¶</div>
                                }
                                else if (!string.IsNullOrWhiteSpace(_profilePlanError))
                                {
                                    <div style="font-size:0.85rem; color:#ef4444;">Plan unavailable</div>
                                }
                                else if (_profilePlanStatus is not null)
                                {
                                    @if (_profilePlanStatus.HasActivePlan)
                                    {
                                        <div style="font-size:0.85rem; color: var(--text-secondary);">Plan</div>
                                        <div style="font-size:0.95rem; font-weight:700; color: var(--text-primary);">
                                            @(_profilePlanStatus.PlanName ?? "Active")
                                        </div>

                                        @if (_profilePlanStatus.IsUnlimited)
                                        {
                                            <div style="margin-top:6px; font-size:0.9rem; font-weight:700; color:#10b981;">
                                                Unlimited usage
                                            </div>
                                        }
                                        else
                                        {
                                            <div style="margin-top:6px; font-size:0.9rem; color: var(--text-secondary);">
                                                Wallet credits: <b>@_profilePlanStatus.WalletCredits.ToString("0.##")</b>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div style="font-size:0.85rem; color: var(--text-secondary);">Credits</div>
                                        <div style="font-size:0.95rem; font-weight:700; color: var(--text-primary);">
                                            @_profilePlanStatus.WalletCredits.ToString("0.##")
                                        </div>
                                    }
                                }
                            </div>
                        </div>

                        <button @onclick="@(() => NavigateTo("/edit-profile"))">
                            Settings
                        </button>

                        <button @onclick="@(() => NavigateTo("/plans"))">
                            Plans
                        </button>

                        <button @onclick="@(() => NavigateTo("/support"))">
                            Help & Support
                        </button>

                        @if (Session.GetUser()?.Role == "Admin")
                        {
                            <button @onclick="@(() => NavigateTo("/admin/panel"))">
                                Admin Panel
                            </button>
                        }

                        <div class="divider"></div>

                        <button class="danger" @onclick="HandleLogout">
                            Log out
                        </button>
                    </div>


                </div>
            }

            @* Main Content Area - Chat and Workspace side by side *@
            <div class="content-area-wrapper">
                @* Chat Area (Body) - resizes when workspace is open *@
                <div class="chat-area-container">
                    <CascadingValue Value="this">
                        @Body
                    </CascadingValue>
                </div>
            </div>
        </div>
    }
    else
    {
        <div style="flex: 1; display: flex; align-items: center; justify-content: center; background: #0a0a0f; height: 100vh; width: 100vw;">
            @Body
        </div>
    }
</div>

@code {
    private bool sidebarOpen = false;
    private bool historyExpanded = false;
#pragma warning disable CS0169 // Field is never used
    private DotNetObjectReference<MainLayout>? _dotNetRef;
#pragma warning restore CS0169
    private List<ChatSummary> allChats = new();
    private List<ChatSummary> displayedChats = new();
    private List<string> availableModels = new();
#pragma warning disable CS0169 // Field is never used
    private bool isProfileMenuOpen;
#pragma warning restore CS0169
    private string? currentModel;
    private bool llmLoading = false;
    private bool _hasInitialized = false;
    private int totalChatCount = 0;
    private bool _wasLoggedIn = false; // üî• REQUIRED FIX
    private int displayedChatCount = 10;
    private string currentTheme = "light";
    private string sidebarError = "";

    // ‚úÖ Profile popover state
    private bool showProfileMenu = false;

    // üìÅ Workspace toggle event - Index.razor subscribes to this
    public event Action? OnWorkspaceToggled;
    public bool IsWorkspaceOpen { get; private set; } = false;

    public void ToggleWorkspace()
    {
        IsWorkspaceOpen = !IsWorkspaceOpen;
        OnWorkspaceToggled?.Invoke();
        StateHasChanged();
    }

    public void SetWorkspaceOpen(bool isOpen)
    {
        IsWorkspaceOpen = isOpen;
        StateHasChanged();
    }

    private void CloseProfileMenu()
    {
        showProfileMenu = false;
    }

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to navigation changes to refresh user data
        Navigation.LocationChanged += OnLocationChanged;

        // üîî Subscribe to credits changed event for immediate updates
        Session.OnCreditsChanged += OnCreditsChanged;

        // üîî Subscribe to user state changed event (fires when fresh user data is loaded)
        Session.OnUserStateChanged += OnUserStateChanged;

        // Load theme preference from localStorage using themeManager
        try
        {
            currentTheme = await JS.InvokeAsync<string>("themeManager.getTheme") ?? "light";
        }
        catch
        {
            currentTheme = "light";
        }
    }

    // üîî Handler for immediate credit updates
    private async void OnCreditsChanged()
    {
        try
        {
            // Refresh profile plan status if the menu is open
            if (showProfileMenu)
            {
                await LoadProfilePlanStatusAsync();
            }
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            // ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
            // ‚ïë                              NEEDS ATTENTION                                  ‚ïë
            // ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
            // ‚ïë ISSUE: Empty catch - credit update failures are silently ignored            ‚ïë
            // ‚ïë WHY: User may see stale credit balance, leading to failed transactions      ‚ïë
            // ‚ïë FIX: Log error and consider showing refresh button if credits seem stale    ‚ïë
            // ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
            Console.WriteLine($"[MainLayout] OnCreditsChanged failed: {ex.Message}");
        }
    }

    // üîî Handler for user state changes (fires when fresh user data is loaded from API)
    private async void OnUserStateChanged()
    {
        try
        {
            // Re-render UI with fresh user data
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            // ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
            // ‚ïë                              NEEDS ATTENTION                                  ‚ïë
            // ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
            // ‚ïë ISSUE: Empty catch - UI may not reflect current user state                  ‚ïë
            // ‚ïë WHY: User profile/permissions may be outdated until manual refresh          ‚ïë
            // ‚ïë FIX: Log error; non-critical but should be monitored                        ‚ïë
            // ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
            Console.WriteLine($"[MainLayout] OnUserStateChanged failed: {ex.Message}");
        }
    }

    private async void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        // Refresh user session/credits on every navigation
        try
        {
            await Session.RefreshUserAsync();
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            // ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
            // ‚ïë                              NEEDS ATTENTION                                  ‚ïë
            // ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
            // ‚ïë ISSUE: Empty catch - session refresh failures go unnoticed                  ‚ïë
            // ‚ïë WHY: Stale session data, incorrect credits, or auth issues persist          ‚ïë
            // ‚ïë FIX: Log error; consider force-logout on repeated auth failures             ‚ïë
            // ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
            Console.WriteLine($"[MainLayout] OnLocationChanged refresh failed: {ex.Message}");
        }
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
        Session.OnCreditsChanged -= OnCreditsChanged;
        Session.OnUserStateChanged -= OnUserStateChanged;
    }


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_hasInitialized)
        {
            _hasInitialized = true;

            // Restore session from localStorage
            await Session.InitializeAsync();

            // üé® Load and apply theme from localStorage on first render
            try
            {
                var savedTheme = await JS.InvokeAsync<string>("themeManager.applyTheme");
                if (!string.IsNullOrEmpty(savedTheme) && savedTheme != currentTheme)
                {
                    currentTheme = savedTheme;
                    StateHasChanged();
                }
            }
            catch (Exception ex)
            {
                // ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
                // ‚ïë                              NEEDS ATTENTION                                  ‚ïë
                // ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
                // ‚ïë ISSUE: Theme loading failure silently ignored                               ‚ïë
                // ‚ïë WHY: User may see wrong theme (jarring UX), JS errors go undetected         ‚ïë
                // ‚ïë FIX: Log error; theme failures are cosmetic but still worth tracking        ‚ïë
                // ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
                Console.WriteLine($"[MainLayout] Theme apply failed: {ex.Message}");
            }
        }

        // üî• Detect LOGIN transition
        var isLoggedIn = Session.IsLoggedIn();

        if (isLoggedIn && !_wasLoggedIn)
        {
            // User JUST logged in (or re-logged in)
            await RefreshChatHistory();
            await LoadModelInfo();
            StateHasChanged();
        }

        _wasLoggedIn = isLoggedIn;
    }

    // ================= PROFILE MENU =================
    private LittleHelperAI.Shared.Models.PlanStatusDto? _profilePlanStatus;
    private bool _profilePlanLoading;
    private string? _profilePlanError;

    private async Task ToggleProfileMenu()
    {
        showProfileMenu = !showProfileMenu;

        // Load plan status when opening (keeps UI fast and avoids extra calls).
        if (showProfileMenu)
        {
            await LoadProfilePlanStatusAsync();
        }
    }

    private async Task LoadProfilePlanStatusAsync()
    {
        var u = Session.GetUser();
        if (u is null || u.Id <= 0)
            return;

        _profilePlanLoading = true;
        _profilePlanError = null;
        try
        {
            _profilePlanStatus = await Http.GetFromJsonAsync<LittleHelperAI.Shared.Models.PlanStatusDto>($"api/plans/status/{u.Id}");
        }
        catch (Exception ex)
        {
            _profilePlanError = ex.Message;
            _profilePlanStatus = null;
        }
        finally
        {
            _profilePlanLoading = false;
        }
    }

    // Uses Email because UserDto doesn't have UserName
    private string GetUserLabel()
    {
        var u = Session.GetUser();
        if (u == null) return "U";

        if (!string.IsNullOrWhiteSpace(u.Username))
            return u.Username;

        if (!string.IsNullOrWhiteSpace(u.Email))
            return u.Email;

        return "User";
    }

    private string GetUserEmail()
    {
        var u = Session.GetUser();
        if (u == null) return string.Empty;
        return string.IsNullOrWhiteSpace(u.Email) ? string.Empty : u.Email;
    }

    private string GetUserRole()
    {
        var u = Session.GetUser();
        if (u == null) return "User";
        return string.IsNullOrWhiteSpace(u.Role) ? "User" : u.Role;
    }



    public async Task ApplyTheme(string theme)
    {
        try
        {
            // Use themeManager to set and apply theme
            await JS.InvokeVoidAsync("themeManager.setTheme", theme);
            currentTheme = theme;
            Console.WriteLine($"[MainLayout] Theme applied: {theme}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[MainLayout] Error applying theme: {ex.Message}");
        }
    }

    private async Task ToggleTheme()
    {
        string newTheme = currentTheme == "dark" ? "light" : "dark";
        await ApplyTheme(newTheme);
        StateHasChanged();
    }

    private void ToggleSidebar() => sidebarOpen = !sidebarOpen;

    private void ToggleHistoryExpand()
    {
        historyExpanded = !historyExpanded;
        UpdateDisplayedChats();
    }

    private void UpdateDisplayedChats()
    {
        if (historyExpanded)
        {
            displayedChats = allChats.ToList();
            displayedChatCount = allChats.Count;
        }
        else
        {
            displayedChats = allChats.Take(10).ToList();
            displayedChatCount = Math.Min(10, allChats.Count);
        }
    }

    private bool IsActive(string path)
    {
        var uri = Navigation.Uri.Replace(Navigation.BaseUri, "/");
        if (path == "/" && uri == "/") return true;
        if (path != "/" && uri.StartsWith(path)) return true;
        return false;
    }

    private async Task NavigateTo(string path)
    {
        // Preserve theme before navigation
        try
        {
            await JS.InvokeVoidAsync("localStorage.setItem", "theme", currentTheme);
        }
        catch (Exception ex)
        {
            // ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
            // ‚ïë                              NEEDS ATTENTION                                  ‚ïë
            // ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
            // ‚ïë ISSUE: Theme persistence failure ignored                                    ‚ïë
            // ‚ïë WHY: User's theme preference won't persist across sessions                  ‚ïë
            // ‚ïë FIX: Log error; localStorage failures indicate browser storage issues       ‚ïë
            // ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
            Console.WriteLine($"[MainLayout] Theme save failed: {ex.Message}");
        }

        Navigation.NavigateTo(path, forceLoad: false);
        if (sidebarOpen) sidebarOpen = false;

        // Re-apply theme after navigation
        await Task.Delay(50); // Small delay to let navigation complete
        await ApplyTheme(currentTheme);
    }

    private async Task RefreshChatHistory()
    {
        var user = Session.GetUser();
        if (user != null)
        {
            try
            {
                var result = await Http.GetFromJsonAsync<List<ChatSummary>>($"api/chat/history/{user.Id}");
                allChats = result ?? new();
                totalChatCount = allChats.Count;
                UpdateDisplayedChats();
                StateHasChanged();
            }
            catch (Exception ex)
            {
                // ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
                // ‚ïë                              NEEDS ATTENTION                                  ‚ïë
                // ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
                // ‚ïë ISSUE: Chat history load failure silently ignored                           ‚ïë
                // ‚ïë WHY: Sidebar shows empty/stale history; user thinks they lost chats         ‚ïë
                // ‚ïë FIX: Show error in sidebar: "Could not load history. Click to retry."       ‚ïë
                // ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
                Console.WriteLine($"[MainLayout] RefreshChatHistory failed: {ex.Message}");
            }
        }
    }

    private void ClearSidebarOnly()
    {
        // Client-only clear (does not touch backend)
        sidebarError = "";
        allChats = new List<ChatSummary>();
        displayedChats = new List<ChatSummary>();
        totalChatCount = 0;
        displayedChatCount = 0;
        historyExpanded = false;
        StateHasChanged();
    }

    private async Task DeleteChat(int chatId)
    {
        sidebarError = "";
        var user = Session.GetUser();
        if (user == null) return;

        bool confirmed = true;
        try
        {
            confirmed = await JS.InvokeAsync<bool>("confirm", "Delete this chat? This removes it from the database.");
        }
        catch { }

        if (!confirmed) return;

        try
        {
            var resp = await Http.DeleteAsync($"api/chat/delete/{chatId}");
            if (!resp.IsSuccessStatusCode)
            {
                sidebarError = "Could not delete chat.";
            }
        }
        catch
        {
            sidebarError = "Could not delete chat.";
        }

        await RefreshChatHistory();
    }

    private async Task DeleteAllChats()
    {
        sidebarError = "";
        var user = Session.GetUser();
        if (user == null) return;

        bool confirmed = true;
        try
        {
            confirmed = await JS.InvokeAsync<bool>("confirm", "Delete ALL chats? This removes them from the database.");
        }
        catch { }

        if (!confirmed) return;

        try
        {
            var resp = await Http.DeleteAsync($"api/chat/delete-all/{user.Id}");
            if (!resp.IsSuccessStatusCode)
            {
                sidebarError = "Could not delete all chats.";
            }
        }
        catch
        {
            sidebarError = "Could not delete all chats.";
        }

        await RefreshChatHistory();
    }

    // üî• PUBLIC METHOD FOR EXTERNAL REFRESH
    public async Task OnMessageSavedAsync()
    {
        await RefreshChatHistory();
    }

    private async Task HandleLogout()
    {
        showProfileMenu = false;
        await Session.LogoutAsync();
        // Force a full page reload to clear any stale state and ensure clean login form
        Navigation.NavigateTo("/", forceLoad: true);
    }

    private void LoadChat(int chatId)
    {
        Navigation.NavigateTo($"/chat/{chatId}");
        if (sidebarOpen) sidebarOpen = false;
    }

    private async Task LoadModelInfo()
    {
        try
        {
            var info = await Http.GetFromJsonAsync<ModelInfoResponse>("api/llm/info");
            if (info != null)
            {
                availableModels = info.AvailableModels ?? new();
                currentModel = info.CurrentModel;
            }
        }
        catch (Exception ex)
        {
            // ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
            // ‚ïë                              NEEDS ATTENTION                                  ‚ïë
            // ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
            // ‚ïë ISSUE: Model info load failure silently ignored                             ‚ïë
            // ‚ïë WHY: User won't see available models in selector; can't switch models       ‚ïë
            // ‚ïë FIX: Show "Models unavailable" in dropdown; log error for debugging         ‚ïë
            // ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
            Console.WriteLine($"[MainLayout] LoadModelInfo failed: {ex.Message}");
        }
    }

    private async Task OnModelChanged()
    {
        if (string.IsNullOrWhiteSpace(currentModel)) return;
        llmLoading = true;
        StateHasChanged();
        try
        {
            await Http.PostAsJsonAsync("api/llm/load", new { ModelName = currentModel });
        }
        catch (Exception ex)
        {
            // ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
            // ‚ïë                              NEEDS ATTENTION                                  ‚ïë
            // ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
            // ‚ïë ISSUE: Model switch failure silently ignored                                ‚ïë
            // ‚ïë WHY: User thinks model changed but old model is still active               ‚ïë
            // ‚ïë FIX: Show error toast: "Failed to switch model"; revert dropdown selection  ‚ïë
            // ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
            Console.WriteLine($"[MainLayout] OnModelChanged failed: {ex.Message}");
        }
        llmLoading = false;
        StateHasChanged();
    }

    public class ChatSummary
    {
        public int Id { get; set; }
        public string Title { get; set; } = "";
    }

    public class ModelInfoResponse
    {
        public string? CurrentModel { get; set; }
        public List<string>? AvailableModels { get; set; }
    }
}
