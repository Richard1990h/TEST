@inject HttpClient Http
@inject NavigationManager Nav

<div class="admin-grid">
    <div class="admin-card admin-card-wide">
        <div class="admin-card-title">Database Snapshots</div>
        <div class="admin-card-sub">Create and download hard copy backups of your database.</div>

        <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; margin-top:12px;">
            <button class="admin-btn admin-btn-primary" @onclick="Create" disabled="@_creating">@(_creating ? "Creating..." : "Create Snapshot Now")</button>
            <button class="admin-btn" @onclick="Refresh" disabled="@_loading">â†» Refresh</button>
        </div>

        @if (_loading)
        {
            <div class="admin-muted" style="margin-top:12px;">Loading snapshots...</div>
        }
        else if (!string.IsNullOrWhiteSpace(_error))
        {
            <div class="admin-error" style="margin-top:12px;">@_error</div>
        }
        else if (_items.Count == 0)
        {
            <div class="admin-muted" style="margin-top:12px;">No snapshots available.</div>
        }
        else
        {
            <div style="display:flex; gap:10px; align-items:center; margin-top:10px;">
                <span class="pill">Total: @_items.Count</span>
            </div>

            <div class="admin-table-wrap" style="margin-top:12px;">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Created (UTC)</th>
                            <th>File Name</th>
                            <th style="width:100px;">Size</th>
                            <th style="width:140px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var s in _items)
                        {
                            <tr>
                                <td>@s.CreatedUtc.ToString("yyyy-MM-dd HH:mm:ss")</td>
                                <td style="font-weight:600;">@s.FileName</td>
                                <td><strong>@FormatBytes(s.Bytes)</strong></td>
                                <td>
                                    <button class="admin-btn admin-btn-xs admin-btn-primary" @onclick="(() => Download(s.FileName))" title="Download snapshot">Download</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>

    <div class="admin-card">
        <div class="admin-card-title">Configuration</div>
        <div class="admin-card-sub">Automated backup settings.</div>

        <div style="margin-top:12px; display:flex; flex-direction:column; gap:8px;">
            <div style="display:flex; gap:8px; padding:10px; background:var(--bg-tertiary); border-radius:10px;">
                <span style="color:var(--text-secondary);">Daily snapshots run automatically</span>
            </div>
        </div>

        <div style="margin-top:14px; padding:14px; background:linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(139, 92, 246, 0.05)); border:1px solid rgba(59, 130, 246, 0.15); border-radius:12px; font-family:var(--font-mono); font-size:13px; color:var(--text-secondary);">
            <div style="font-weight:700; color:var(--text-primary); margin-bottom:8px;">appsettings.json:</div>
            <div>Snapshots:EnableDaily</div>
            <div>Snapshots:HourUtc</div>
            <div>Snapshots:KeepDays</div>
        </div>
    </div>
</div>

@code {
    private bool _loading;
    private bool _creating;
    private string? _error;
    private List<SnapshotItem> _items = new();

    protected override async Task OnInitializedAsync() => await LoadAsync();

    public async Task Refresh() => await LoadAsync();

    private async Task LoadAsync()
    {
        _loading = true;
        _error = null;
        try
        {
            _items = await Http.GetFromJsonAsync<List<SnapshotItem>>("api/admin/snapshots") ?? new();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task Create()
    {
        _creating = true;
        _error = null;
        StateHasChanged();

        try
        {
            var resp = await Http.PostAsync("api/admin/snapshots/create", null);
            if (!resp.IsSuccessStatusCode)
            {
                _error = await resp.Content.ReadAsStringAsync();
                return;
            }
            await LoadAsync();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _creating = false;
        }
    }

    private void Download(string fileName)
    {
        var url = $"api/admin/snapshots/download/{Uri.EscapeDataString(fileName)}";
        Nav.NavigateTo(url, forceLoad: true);
    }

    private static string FormatBytes(long b)
    {
        if (b < 1024) return $"{b} B";
        if (b < 1024 * 1024) return $"{b / 1024.0:0.##} KB";
        return $"{b / (1024.0 * 1024.0):0.##} MB";
    }

    private sealed class SnapshotItem
    {
        public string FileName { get; set; } = "";
        public DateTime CreatedUtc { get; set; }
        public long Bytes { get; set; }
    }
}
